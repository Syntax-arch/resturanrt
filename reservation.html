<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>äºˆç´„ä¸€è¦§ - ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; font-family: "Noto Sans JP", sans-serif; }
    .container { margin-top: 60px; }
    table { background-color: #fff; border-radius: 0.5rem; overflow: hidden; }
  </style>
</head>
<body>
  <div class="sakura-decoration"></div>
  
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #c62828;">
    <div class="container">
      <a class="navbar-brand fw-bold" href="dashboard.html">
        ğŸ£ ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³äºˆç´„ã‚·ã‚¹ãƒ†ãƒ 
      </a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3" id="userWelcome">
          ã‚ˆã†ã“ãï¼
        </span>
        <a href="dashboard.html" class="btn btn-outline-light btn-sm me-2">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
        <button class="btn btn-outline-light btn-sm" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="japanese-header">
        <h2>äºˆç´„ä¸€è¦§</h2>
      </div>
      <div>
        <button class="btn btn-japanese me-2" data-bs-toggle="modal" data-bs-target="#addReservationModal">
          æ–°è¦äºˆç´„
        </button>
      </div>
    </div>
    
    <table class="table table-striped table-hover text-center japanese-table">
      <thead>
        <tr>
          <th>åå‰</th>
          <th>æ—¥ä»˜</th>
          <th>æ™‚é–“</th>
          <th>äººæ•°</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="reservationsTable">
        <!-- Data will be loaded here -->
      </tbody>
    </table>
    
    <a href="dashboard.html" class="btn btn-secondary mt-3">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
  </div>

  <!-- Add Reservation Modal -->
  <div class="modal fade" id="addReservationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æ–°è¦äºˆç´„</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="reservationForm">
            <div class="mb-3">
              <label class="form-label">ãŠå®¢æ§˜å</label>
              <input type="text" class="form-control" id="customerName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">æ—¥ä»˜</label>
              <input type="date" class="form-control" id="reservationDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">æ™‚é–“</label>
              <input type="time" class="form-control" id="reservationTime" required>
            </div>
            <div class="mb-3">
              <label class="form-label">äººæ•°</label>
              <input type="number" class="form-control" id="guests" min="1" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-japanese" id="saveReservation">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Check authentication FIRST
    const currentUser = JSON.parse(localStorage.getItem('user'));
    if (!currentUser) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
      window.location.href = 'login.html';
    }

    // Update welcome message
    document.getElementById('userWelcome').textContent = `ã‚ˆã†ã“ãã€${currentUser.name}ã•ã‚“ï¼`;

    // Supabase configuration
    const SUPABASE_URL = 'https://nfcjbjohxzaikelxgmjg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mY2piam9oeHphaWtlbHhnbWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNTgzMjAsImV4cCI6MjA3NjYzNDMyMH0.u0ta1NxSDbJ_9lf1TcMp3M0-_vNNBs6HByOj8wtKsX4';
    
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Load reservations
    async function loadReservations() {
      try {
        const { data, error } = await supabaseClient
          .from('reservations')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('date', { ascending: true });
          
        if (error) throw error;
        
        const tbody = document.getElementById('reservationsTable');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
          return;
        }
        
        data.forEach(reservation => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${reservation.customer_name}</td>
            <td>${reservation.date}</td>
            <td>${reservation.time}</td>
            <td>${reservation.guests}äºº</td>
            <td>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteReservation('${reservation.id}')">
                å‰Šé™¤
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading reservations:', error);
      }
    }
    
    // Add new reservation
    document.getElementById('saveReservation').addEventListener('click', async () => {
      const customerName = document.getElementById('customerName').value;
      const date = document.getElementById('reservationDate').value;
      const time = document.getElementById('reservationTime').value;
      const guests = document.getElementById('guests').value;
      
      if (!customerName || !date || !time || !guests) {
        alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const { data, error } = await supabaseClient
          .from('reservations')
          .insert([{
            user_id: currentUser.id,
            customer_name: customerName,
            date: date,
            time: time,
            guests: parseInt(guests)
          }]);
          
        if (error) throw error;
        
        // Close modal and refresh
        bootstrap.Modal.getInstance(document.getElementById('addReservationModal')).hide();
        document.getElementById('reservationForm').reset();
        loadReservations();
        
        alert('äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    });
    
    // Delete reservation
    window.deleteReservation = async (id) => {
      if (confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        try {
          const { error } = await supabaseClient
            .from('reservations')
            .delete()
            .eq('id', id);
            
          if (error) throw error;
          
          loadReservations();
          alert('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        } catch (error) {
          alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
      }
    };
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem('user');
        window.location.href = 'index.html';
      }
    });
    
    // Load reservations on page load
    loadReservations();
  </script>
</body>
</html>