<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>予約一覧</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>
<a href="dashboard.html" class="btn btn-japanese mt-3 ms-2">ダッシュボードに戻る</a>
<body>
  
<script>

</script>


<div class="d-flex justify-content-between align-items-center mb-4">
  <div class="japanese-header">
    <h2>予約一覧</h2>
  </div>
  <div>
    <a href="dashboard.html" class="btn btn-secondary me-2">← ダッシュボード</a>
    <button class="btn btn-japanese me-2" data-bs-toggle="modal" data-bs-target="#addReservationModal">
      新規予約
    </button>
    <button class="btn btn-outline-danger" id="logoutBtn">
      ログアウト
    </button>
  </div>
</div>
  <div class="sakura-decoration"></div>
  <div class="container" style="margin-top: 60px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="japanese-header">
        <h2>予約一覧</h2>
      </div>
      <div>
        <button class="btn btn-japanese me-2" data-bs-toggle="modal" data-bs-target="#addReservationModal">
          新規予約
        </button>
        <button class="btn btn-outline-secondary" id="logoutBtn">
          ログアウト
        </button>
      </div>
    </div>
    
    <table class="table table-striped table-hover text-center japanese-table">
      <thead>
        <tr>
          <th>名前</th>
          <th>日付</th>
          <th>時間</th>
          <th>人数</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="reservationsTable">
        <!-- Data will be loaded here -->
      </tbody>
    </table>
    
    <a href="index.html" class="btn btn-secondary mt-3">← ホームに戻る</a>
  </div>

  <!-- Add Reservation Modal -->
  <div class="modal fade" id="addReservationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新規予約</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="reservationForm">
            <div class="mb-3">
              <label class="form-label">お客様名</label>
              <input type="text" class="form-control" id="customerName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">日付</label>
              <input type="date" class="form-control" id="reservationDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">時間</label>
              <input type="time" class="form-control" id="reservationTime" required>
            </div>
            <div class="mb-3">
              <label class="form-label">人数</label>
              <input type="number" class="form-control" id="guests" min="1" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-japanese" id="saveReservation">保存</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  alert('ログインが必要です');
  window.location.href = 'login.html';
  throw new Error('User not authenticated');


const SUPABASE_URL = 'https://nfcjbjohxzaikelxgmjg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mY2piam9oeHphaWtlbHhnbWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNTgzMjAsImV4cCI6MjA3NjYzNDMyMH0.u0ta1NxSDbJ_9lf1TcMp3M0-_vNNBs6HByOj8wtKsX4';


const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

console.log('Dashboard loaded for user:', user);
    
   
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      window.location.href = 'login.html';
    }
    
    
    async function loadReservations() {
      try {
        const { data, error } = await supabaseClient
          .from('reservations')
          .select('*')
          .order('date', { ascending: true });
          
        if (error) throw error;
        
        const tbody = document.getElementById('reservationsTable');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">予約がありません</td></tr>';
          return;
        }
        
        data.forEach(reservation => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${reservation.customer_name}</td>
            <td>${reservation.date}</td>
            <td>${reservation.time}</td>
            <td>${reservation.guests}人</td>
            <td>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteReservation('${reservation.id}')">
                削除
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading reservations:', error);
      }
    }
    
    // Add new reservation
    document.getElementById('saveReservation').addEventListener('click', async () => {
      const customerName = document.getElementById('customerName').value;
      const date = document.getElementById('reservationDate').value;
      const time = document.getElementById('reservationTime').value;
      const guests = document.getElementById('guests').value;
      
      try {
        const { data, error } = await supabaseClient
          .from('reservations')
          .insert([{
            user_id: user.id,
            customer_name: customerName,
            date: date,
            time: time,
            guests: parseInt(guests)
          }]);
          
        if (error) throw error;
        
        // Close modal and refresh
        bootstrap.Modal.getInstance(document.getElementById('addReservationModal')).hide();
        document.getElementById('reservationForm').reset();
        loadReservations();
        
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    });
    
    // Delete reservation
    window.deleteReservation = async (id) => {
      if (confirm('この予約を削除しますか？')) {
        try {
          const { error } = await supabaseClient
            .from('reservations')
            .delete()
            .eq('id', id);
            
          if (error) throw error;
          
          loadReservations();
        } catch (error) {
          alert('エラー: ' + error.message);
        }
      }
    };
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    });
    
    // Load reservations on page load
    loadReservations();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>