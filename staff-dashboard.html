<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スタッフダッシュボード - レストラン予約システム</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .staff-sidebar {
      background: #34495e;
      color: white;
      min-height: 100vh;
      padding: 0;
    }
    .staff-sidebar .nav-link {
      color: #ecf0f1;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #2c3e50;
      transition: all 0.3s ease;
    }
    .staff-sidebar .nav-link:hover,
    .staff-sidebar .nav-link.active {
      background: #2c3e50;
      color: #3498db;
    }
    .staff-main {
      background: #f8f9fa;
      min-height: 100vh;
    }
    .staff-card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    .staff-card:hover {
      transform: translateY(-3px);
    }
    .today-schedule {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .upcoming-reservations {
      background: linear-gradient(135deg, #f093fb, #f5576c);
      color: white;
    }
    .task-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .task-item {
      padding: 0.75rem;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: between;
    }
    .task-item.completed {
      opacity: 0.6;
      text-decoration: line-through;
    }
  </style>
</head>
<body>
  <!-- Staff Navigation -->
  <nav class="navbar navbar-dark" style="background-color: #2980b9;">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="staff-dashboard.html">
        👥 スタッフダッシュボード
      </a>
      <div class="navbar-nav ms-auto flex-row">
        <span class="navbar-text me-3" id="staffWelcome">
          スタッフ
        </span>
        <button class="btn btn-outline-light btn-sm me-2" onclick="refreshDashboard()">
          🔄 更新
        </button>
        <button class="btn btn-outline-light btn-sm" id="staffLogoutBtn">
          ログアウト
        </button>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 staff-sidebar">
        <div class="d-flex flex-column flex-shrink-0 p-3">
          <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
              <a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">
                📊 ダッシュボード
              </a>
            </li>
            <li class="nav-item">
              <a href="#schedule" class="nav-link" onclick="showSection('schedule')">
                📅 勤務表
              </a>
            </li>
            <li class="nav-item">
              <a href="#reservations" class="nav-link" onclick="showSection('reservations')">
                🎯 本日の予約
              </a>
            </li>
            <li class="nav-item">
              <a href="#tasks" class="nav-link" onclick="showSection('tasks')">
                ✅ タスク管理
              </a>
            </li>
            <li class="nav-item">
              <a href="#profile" class="nav-link" onclick="showSection('profile')">
                👤 プロフィール
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-md-10 staff-main p-4">
        
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section-content">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>📊 スタッフダッシュボード</h3>
            <div class="text-muted" id="currentTime"></div>
          </div>

          <!-- Stats Cards -->
          <div class="row mb-4">
            <div class="col-md-3 mb-3">
              <div class="card staff-card today-schedule">
                <div class="card-body text-center">
                  <div class="h4 mb-2" id="shiftHours">--:--</div>
                  <small>本日の勤務時間</small>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card staff-card upcoming-reservations">
                <div class="card-body text-center">
                  <div class="h4 mb-2" id="todayReservations">0</div>
                  <small>本日の予約</small>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card staff-card text-white" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                <div class="card-body text-center">
                  <div class="h4 mb-2" id="pendingTasks">0</div>
                  <small>未完了タスク</small>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card staff-card text-white" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                <div class="card-body text-center">
                  <div class="h4 mb-2" id="completedTasks">0</div>
                  <small>完了タスク</small>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Today's Schedule -->
            <div class="col-md-6 mb-4">
              <div class="card staff-card h-100">
                <div class="card-header">
                  <h6 class="mb-0">📅 本日の勤務</h6>
                </div>
                <div class="card-body" id="todaySchedule">
                  <!-- Today's schedule will be loaded here -->
                </div>
              </div>
            </div>

            <!-- Upcoming Reservations -->
            <div class="col-md-6 mb-4">
              <div class="card staff-card h-100">
                <div class="card-header">
                  <h6 class="mb-0">🎯 直近の予約</h6>
                </div>
                <div class="card-body" id="upcomingReservations">
                  <!-- Upcoming reservations will be loaded here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Tasks -->
          <div class="row">
            <div class="col-12">
              <div class="card staff-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">✅ 本日のタスク</h6>
                  <button class="btn btn-sm btn-primary" onclick="showSection('tasks')">
                    すべて表示
                  </button>
                </div>
                <div class="card-body">
                  <div id="quickTasks" class="task-list">
                    <!-- Quick tasks will be loaded here -->
                  </div>
                  <div class="mt-3">
                    <input type="text" class="form-control" id="newTaskInput" placeholder="新しいタスクを追加...">
                    <button class="btn btn-success btn-sm mt-2" onclick="addNewTask()">タスク追加</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule Section -->
        <div id="schedule-section" class="section-content d-none">
          <h3 class="mb-4">📅 勤務表</h3>
          <div class="card staff-card">
            <div class="card-body">
              <div id="staffSchedule">
                <!-- Staff schedule will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Reservations Section -->
        <div id="reservations-section" class="section-content d-none">
          <h3 class="mb-4">🎯 本日の予約</h3>
          <div class="card staff-card">
            <div class="card-body">
              <div id="todayReservationsList">
                <!-- Today's reservations list will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Tasks Section -->
        <div id="tasks-section" class="section-content d-none">
          <h3 class="mb-4">✅ タスク管理</h3>
          <div class="card staff-card">
            <div class="card-body">
              <div class="d-flex mb-3">
                <input type="text" class="form-control me-2" id="taskInput" placeholder="新しいタスク...">
                <button class="btn btn-primary" onclick="addTask()">追加</button>
              </div>
              <div id="taskList">
                <!-- Task list will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" class="section-content d-none">
          <h3 class="mb-4">👤 プロフィール</h3>
          <div class="card staff-card">
            <div class="card-body">
              <div id="staffProfile">
                <!-- Staff profile will be loaded here -->
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://nfcjbjohxzaikelxgmjg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mY2piam9oeHphaWtlbHhnbWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNTgzMjAsImV4cCI6MjA3NjYzNDMyMH0.u0ta1NxSDbJ_9lf1TcMp3M0-_vNNBs6HByOj8wtKsX4'
    );

    // Check staff authentication
    const staffUser = JSON.parse(localStorage.getItem('staffUser'));
    if (!staffUser) {
      alert('スタッフ権限が必要です');
      window.location.href = 'staff-login.html';
    }

    // Update welcome message
    document.getElementById('staffWelcome').textContent = `ようこそ、${staffUser.name}さん`;

    // Update current time
    function updateCurrentTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = 
        `現在時刻: ${now.toLocaleString('ja-JP')}`;
    }
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();

    // Section navigation
    function showSection(sectionName) {
      document.querySelectorAll('.section-content').forEach(section => {
        section.classList.add('d-none');
      });
      document.getElementById(`${sectionName}-section`).classList.remove('d-none');
      
      document.querySelectorAll('.staff-sidebar .nav-link').forEach(link => {
        link.classList.remove('active');
      });
      event.target.classList.add('active');

      // Load section-specific data
      if (sectionName === 'schedule') loadStaffSchedule();
      if (sectionName === 'reservations') loadTodayReservations();
      if (sectionName === 'tasks') loadAllTasks();
      if (sectionName === 'profile') loadStaffProfile();
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // Load today's schedule
        const { data: schedule, error: scheduleError } = await supabase
          .from('staff_schedules')
          .select('*')
          .eq('staff_id', staffUser.id)
          .eq('date', today)
          .single();

        if (!scheduleError && schedule) {
          document.getElementById('shiftHours').textContent = 
            `${schedule.start_time} - ${schedule.end_time}`;
          
          const scheduleContainer = document.getElementById('todaySchedule');
          scheduleContainer.innerHTML = `
            <div class="text-center">
              <h5>${schedule.start_time} - ${schedule.end_time}</h5>
              <p class="text-muted">${schedule.role || 'スタッフ'}</p>
              <p>${schedule.notes || '特記事項なし'}</p>
            </div>
          `;
        }

        // Load today's reservations
        const { data: reservations, error: resError } = await supabase
          .from('reservations')
          .select('*')
          .eq('date', today)
          .order('time', { ascending: true });

        if (!resError) {
          document.getElementById('todayReservations').textContent = reservations.length;
          
          const upcomingContainer = document.getElementById('upcomingReservations');
          upcomingContainer.innerHTML = '';
          
          reservations.slice(0, 5).forEach(reservation => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
              <div class="d-flex justify-content-between">
                <strong>${reservation.customer_name}</strong>
                <small class="text-muted">${reservation.time}</small>
              </div>
              <small>${reservation.guests}名 - テーブル${reservation.table_number || '未定'}</small>
              <div><small>${reservation.notes || ''}</small></div>
            `;
            upcomingContainer.appendChild(item);
          });
        }

        // Load tasks
        await loadTasks();

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Task management functions
    async function loadTasks() {
      const { data: tasks, error } = await supabase
        .from('staff_tasks')
        .select('*')
        .eq('staff_id', staffUser.id)
        .order('created_at', { ascending: false });

      if (!error) {
        const pending = tasks.filter(task => !task.completed).length;
        const completed = tasks.filter(task => task.completed).length;
        
        document.getElementById('pendingTasks').textContent = pending;
        document.getElementById('completedTasks').textContent = completed;

        // Update quick tasks
        const quickTasksContainer = document.getElementById('quickTasks');
        quickTasksContainer.innerHTML = '';
        
        tasks.slice(0, 5).forEach(task => {
          const item = document.createElement('div');
          item.className = `task-item ${task.completed ? 'completed' : ''}`;
          item.innerHTML = `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" ${task.completed ? 'checked' : ''} 
                onchange="toggleTask(${task.id}, this.checked)">
              <label class="form-check-label">${task.description}</label>
            </div>
            <small class="text-muted">${new Date(task.created_at).toLocaleDateString('ja-JP')}</small>
          `;
          quickTasksContainer.appendChild(item);
        });
      }
    }

    async function addNewTask() {
      const input = document.getElementById('newTaskInput');
      const description = input.value.trim();
      
      if (description) {
        const { error } = await supabase
          .from('staff_tasks')
          .insert([{
            staff_id: staffUser.id,
            description: description,
            completed: false
          }]);

        if (!error) {
          input.value = '';
          await loadTasks();
          await loadAllTasks();
        }
      }
    }

    async function toggleTask(taskId, completed) {
      await supabase
        .from('staff_tasks')
        .update({ completed: completed, completed_at: completed ? new Date().toISOString() : null })
        .eq('id', taskId);
      
      await loadTasks();
      await loadAllTasks();
    }

    async function loadAllTasks() {
      const { data: tasks, error } = await supabase
        .from('staff_tasks')
        .select('*')
        .eq('staff_id', staffUser.id)
        .order('completed')
        .order('created_at', { ascending: false });

      if (!error) {
        const container = document.getElementById('taskList');
        container.innerHTML = '';
        
        tasks.forEach(task => {
          const item = document.createElement('div');
          item.className = `task-item ${task.completed ? 'completed' : ''}`;
          item.innerHTML = `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" ${task.completed ? 'checked' : ''} 
                onchange="toggleTask(${task.id}, this.checked)">
              <label class="form-check-label">${task.description}</label>
            </div>
            <div>
              <small class="text-muted">${new Date(task.created_at).toLocaleDateString('ja-JP')}</small>
              ${task.completed ? 
                `<small class="text-success ms-2">完了: ${new Date(task.completed_at).toLocaleDateString('ja-JP')}</small>` : 
                ''}
            </div>
          `;
          container.appendChild(item);
        });
      }
    }

    // Load staff schedule
    async function loadStaffSchedule() {
      const { data: schedule, error } = await supabase
        .from('staff_schedules')
        .select('*')
        .eq('staff_id', staffUser.id)
        .order('date', { ascending: true })
        .limit(7);

      if (!error) {
        const container = document.getElementById('staffSchedule');
        container.innerHTML = '';
        
        schedule.forEach(shift => {
          const item = document.createElement('div');
          item.className = 'activity-item';
          item.innerHTML = `
            <div class="d-flex justify-content-between">
              <strong>${new Date(shift.date).toLocaleDateString('ja-JP', { weekday: 'short', month: 'short', day: 'numeric' })}</strong>
              <span>${shift.start_time} - ${shift.end_time}</span>
            </div>
            <div class="text-muted">${shift.role || 'スタッフ'} - ${shift.notes || ''}</div>
          `;
          container.appendChild(item);
        });
      }
    }

    // Load today's reservations
    async function loadTodayReservations() {
      const today = new Date().toISOString().split('T')[0];
      const { data: reservations, error } = await supabase
        .from('reservations')
        .select('*')
        .eq('date', today)
        .order('time', { ascending: true });

      if (!error) {
        const container = document.getElementById('todayReservationsList');
        container.innerHTML = '';
        
        reservations.forEach(reservation => {
          const item = document.createElement('div');
          item.className = 'activity-item';
          item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6>${reservation.customer_name}</h6>
                <div>${reservation.time} - ${reservation.guests}名</div>
                <div class="text-muted">テーブル: ${reservation.table_number || '未定'}</div>
                <div class="text-muted">${reservation.notes || ''}</div>
              </div>
              <span class="badge bg-primary">${reservation.status || '確認中'}</span>
            </div>
          `;
          container.appendChild(item);
        });
      }
    }

    // Load staff profile
    async function loadStaffProfile() {
      const container = document.getElementById('staffProfile');
      container.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h5>基本情報</h5>
            <table class="table">
              <tr><th>名前</th><td>${staffUser.name}</td></tr>
              <tr><th>スタッフコード</th><td>${staffUser.staff_code}</td></tr>
              <tr><th>役職</th><td>${staffUser.role || 'スタッフ'}</td></tr>
              <tr><th>メール</th><td>${staffUser.email || '未設定'}</td></tr>
              <tr><th>電話番号</th><td>${staffUser.phone || '未設定'}</td></tr>
            </table>
          </div>
          <div class="col-md-6">
            <h5>勤務情報</h5>
            <table class="table">
              <tr><th>最終ログイン</th><td>${staffUser.last_login ? new Date(staffUser.last_login).toLocaleString('ja-JP') : '初回ログイン'}</td></tr>
              <tr><th>アカウント状態</th><td><span class="badge bg-success">アクティブ</span></td></tr>
            </table>
          </div>
        </div>
      `;
    }

    // Refresh dashboard
    function refreshDashboard() {
      loadDashboard();
    }

    // Logout
    document.getElementById('staffLogoutBtn').addEventListener('click', () => {
      if (confirm('スタッフからログアウトしますか？')) {
        localStorage.removeItem('staffUser');
        window.location.href = 'staff-login.html';
      }
    });

    // Initialize dashboard
    loadDashboard();
  </script>
</body>
</html>